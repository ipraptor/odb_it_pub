# Identity Collector - Check Point
#CheckPoint #ActiveDirectory 

# Отличия от ADQuery

| ADQuery |Identity Collector |
| -------- | -------- |
| SMS выполняет запросы непосредственно к шлюзу безопасности | Ставится плагин и он уже через API обращается к Domain Controller на Windows Server и к CheckPoint |

> [!Note]
:information_source: Cборщик идентификационных данных можно установить непосредственно на одном из контроллеров домена.


# Плюсы IC

* Снижает нагрузку на SG т.к. запросы выполняет агент коллектора.
* Снижает нагрузку на Windows т.к. используемый API для обращения к Windows потребляет меньше ресурсов.
* Пользователь AD использующийся для сбора событий не требует прав администратора или особых разрешений.
* Один агент может обслуживать несколько шлюзов, даже из разны CMA.

# Требования
spoiler ## **ОБЯЗАТЕЛЬНЫЕ ТРЕБОВАНИЯ**
* WindowsServer2008 - 2022
* Имеет подключение к контроллерам домена AD организации с помощью DNS, LDAP и DCOM
* При наличии межсетевого экрана (включая брандмауэр Windows), убедитесь, что правила разрешают трафик DNS, LDAP и DCOM с компьютера, на котором установлен сборщик удостоверений.
* В брандмауэре Windows добавьте следующее правило «Разрешить»: «» --> «». Remote Event Log Management  Remote Event Log Management (RPC) 
* Имеет подключение к шлюзу безопасности через TCP-порт 443.
* Учетная запись администратора требуется для установки Identity Collector и для запуска процесса пользовательского интерфейса Identity Collector.
* Установлена платформа .NET Framework (версия 4).
* Не менее 8 ГБ оперативной памяти.
* Не менее 10 ГБ свободного места на диске.
    success
    **Рекомендуется:** 16 ГБ ОЗУ, 12-ядерная машина с не менее 60 ГБ свободного     места.
    
* Oracle Java JRE 1.8 (Java SE Runtime Environment 8), необходимый для интеграции **Cisco ISE PxGrid** 1.0. Для интеграции **Cisco ISE PxGrid 2.0** можно использовать Open JDK.
    > [!Warning]
    **ПРИМЕЧАНИЕ: Identity Collector поддерживается только на централизованно     управляемых устройствах SMB для версий R80.20.35 и выше.**
    


spoiler ## **ДОПОЛНИТЕЛЬНЫЕ ТРЕБОВАНИЯ**
* Для работы со шлюзом безопасности R77.20 / R77.30 на этом шлюзе безопасности должно быть установлено исправление (требуемое исправление уже интегрировано в шлюз безопасности R80.10).
* Для интеграции с AD — сборщику удостоверений требуется пользователь AD, принадлежащий к группе читателей журнала событий по умолчанию. Для этого пользователя не требуется административная роль.
* Никаких изменений схемы AD не требуется.
* Сборщик удостоверений предоставляет шлюзу безопасности сведения о пользователях, компьютерах и IP-адресах. Учетные устройства LDAP должны быть настроены таким образом, чтобы шлюзы PDP могли выполнять групповой поиск идентификаторов, предоставленных сборщиком удостоверений, для сопоставления их с ролями доступа.

## ОГРАНИЧЕНИЯ
* Identity Collector может взаимодействовать с 35 серверами Active Directory.
* Сборщик удостоверений может обрабатывать до 1900 событий AD в секунду.





# Необходимые порты
| Направление трафика | Порт | Протокол | Заметка  |
|-|-|-|-|
| Agent to GW | 443 | Собственный протокол CheckPoint работающий поверх https | Агент передаёт информацию о пользователе и IP  |
| GW to DC | 389 | LDAP | Шлюз запрашивает группы в которых находится этот пользователь.  |
| Agent to DC | 53 | DNS |   |
| Agent to DC | 389 | LDAP |   |
| Agent to DC | 135 and dyn allocated ports | DCOM protocol, используется для DCE/RPC |   |


# Алгоритм работы

1) Пользователь логинится в домене
2) IC получает эти данные и отфильтровывает (например вместо 10 событий от 1 пользователя на GW будет отправлено только 1 событие)
3) GW установил пользователя и запрашивает группы в которых тот состоит

   graphviz
digraph hierarchy {

                nodesep=1.0 // increases the separation between nodes

                node [color=red,fontname=Courier,shape=box] //All nodes will this shape and colour
                log [color=green, fontname=Courier,shape=circle]
                filtring [color=orange, fontname=Courier,shape=triangle]
                in_whitch_group_this_user [color=orange, fontname=Courier,shape=triangle]
                login [color=orange, fontname=Courier,shape=triangle]
                edge [color=blue, style=dashed] //All the lines look like this

                {Пользователь}->{login}->{Domain_Controller}->log->
                {Identity_Collector}->{filtring}->
                {Security_Gateway}->{in_whitch_group_this_user}->DomainController            
}
   


## Избыточность Identity Collector

В настоящее время Identity Collector не предлагает избыточность «из коробки». Однако эта функция может быть предложена в следующей конфигурации:

-   Установите Identity Collector на двух отдельных компьютерах с сервером Windows.
-   Настройте оба для запросов к одним и тем же серверам удостоверений и шлюзам (все конфигурации идентичны).

При такой конфигурации у вас будет резервирование «Активный/Активный».

Это изменение не должно сильно повлиять на контроллеры домена, так как сборщик удостоверений API использует легкий потребитель ресурсов. На стороне шлюза будет обработано только первое событие (второе будет проигнорировано).
