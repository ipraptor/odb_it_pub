# Аунтентификация PAP CHAP RADIUS
#AAA #PAP #CHAP 


# RADIUS [RADIUS — Википедия (wikipedia.org)](https://ru.wikipedia.org/wiki/RADIUS)
> [!Note]
:information_source: **RADIUS (Remote Authentication Dial-In User Service)** — это метод внешней проверки подлинности, который обеспечивает безопасность и масштабируемость, отделяя функцию проверки подлинности от сервера доступа.


| Протокол | Полное название протокола                   | Передача пароля      |
|:-------- | ------------------------------------------- |:-------------------- |
| PAP      | Password Authentication Protocol.           | В открытом виде      |
| CHAP     | Challenge Handshake Authentication Protocol | В зашифрованном виде |
| MSCHAPv1 |                                             |                      |
| MSCHAPv2 |                                             |                      |


## PAP
1) Клиент инициирует подключение, отправляет пароль
2) Сервер отвечает либо «Да», либо «Нет»

## Недостатки PAP
> [!Warning]
:information_source: В случае подмены IP адреса сервера на устройство злоумышленника мы по сути просто передаём ему пароль, с которым он в дальнейшем может делать всё что угодно. Чтобы избежать такой ситуации был придуман CHAP.


## CHAP
1) Клиент инициирует подключение
2) Сервер передаёт клиенту случайную строку
3) Клиент берёт пароль и эту строку и вычисляет от неё MD5 хэш который возвращает серверу
4) Сервер проделывает тоже самое (при этом сервер должен знать правильный пароль)
5) При условии если хэши совпадают - клиент авторизован

## Недостатки CHAP
> [!Warning]
:information_source: В [CHAP](https://ru.wikipedia.org/wiki/CHAP "CHAP") сервер должен хранить в обратимо-зашифрованном виде пароль клиента, который расшифровывается при каждой проверке подлинности клиента.


## MS CHAPv1
> [!Note]
:information_source: В отличии от CHAP, MS-CHAP v1 серверу нет необходимости хранить пароль в обратимо-зашифрованном виде, для этого требуется только [MD4](https://ru.wikipedia.org/wiki/MD4 "MD4")-хеш пароля


1.  Клиент отправляет серверу запрос на вход.
2.  Сервер в ответ отправляет 8-байтовый случайный отклик(Challenge).
3.  Клиент использует [LAN Manager хеш](https://ru.wikipedia.org/wiki/LM-%D1%85%D0%B5%D1%88 "LM-хеш") своего пароля, добавляет к 16-байтовому результату пять нулевых байт и делит полученную 21-байтовую строку на три части по 7 байт, чтобы получить три ключа для DES. Каждый из этих ключей используется для шифрования Challenge, присланного сервером. Все три результирующих шифрованных блока объединяются в 24-байтовый LMChallengeResponse. Также клиент создаёт второй 24-байтовый NTChallengeResponse, используя Windows NT хеш и ту же процедуру. Затем оба значения, LMChallengeResponse и NTChallengeResponse, а также флаг «Использовать NTChallengeResponse» размером в 1 байт отправляются серверу.
4.  Сервер использует для расшифровки полученного ответа соответствующий флагу хеш клиентского пароля, который хранится в базе данных. Если расшифрованные блоки соответствуют значению Challenge, аутентификация завершается, и клиенту отсылается Success-пакет.




## MS CHAPv2
| Проблема протокола MS-CHAP версии 1                                                                                                                | Решение протокола MS-CHAP версии 2 |
|:-------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------- |
| Шифрование ответа LAN Manager, применяемое для обратной совместимости со старыми клиентами удаленного доступа Microsoft, криптографически уязвимо. |MS-CHAP v2 больше не разрешает использовать шифрованные ответы LAN Manager, поскольку [LAN Manager хеш](https://ru.wikipedia.org/wiki/LM-%D1%85%D0%B5%D1%88 "LM-хеш") является гораздо более слабой хеш-функцией и может быть взломан, а затем использован для взлома Windows NT хеша. Таким образом, исключив LAN Manager хеш в MS-CHAPv2, Microsoft сделала невозможной атаку методом «[разделяй и властвуй](https://ru.wikipedia.org/wiki/%D0%A0%D0%B0%D0%B7%D0%B4%D0%B5%D0%BB%D1%8F%D0%B9_%D0%B8_%D0%B2%D0%BB%D0%B0%D1%81%D1%82%D0%B2%D1%83%D0%B9_(%D0%B8%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%82%D0%B8%D0%BA%D0%B0) "Разделяй и властвуй (информатика)")» [\[3\]](https://ru.wikipedia.org/wiki/MS-CHAP#cite_note-_81b6b7a0b983d34f-3).|
| Шифрование изменения пароля LAN Manager криптографически уязвимо. | MS-CHAP v2 больше не разрешает использовать шифрованные изменения пароля LAN Manager. |
| Возможна только односторонняя проверка подлинности. Клиент удаленного доступа не может проверить, подключается ли он к серверу удаленного доступа своей организации или к маскирующемуся серверу. | MS-CHAP v2 обеспечивает двустороннюю проверку подлинности, называемую также взаимной проверкой подлинности. Клиент удаленного доступа получает подтверждение, что сервер удаленного доступа, к которому он пытается подключиться, имеет доступ к паролю пользователя.|
| При использовании 40-битного шифрования ключ шифрования основан на пароле пользователя. Всякий раз, когда пользователь подключается с одним и тем же паролем, создается один и тот же ключ шифрования. | В MS-CHAP v2 ключ шифрования всегда основан на пароле пользователя и произвольной строке запроса. Каждый раз, когда пользователь подключается с одним и тем же паролем, создаются разные ключи шифрования.|
| Для данных, пересылаемых по подключению в обоих направлениях, используется единый ключ шифрования. | При использовании протокола MS-CHAP v2 создаются отдельные ключи шифрования для приёма и передачи данных.|


-   1\. Клиент отправляет серверу запрос на аутентификацию, открыто передавая свой логин.
-   2\. Сервер отправляет обратно 16-байтовый случайный отклик «Authenticator Challenge».
-   3а. Клиент создаёт 16-байтовое случайное число, называемое «Peer Authenticator Challenge».
-   3b. Клиент конкатенирует «Peer Authenticator Challenge» с «Authenticator Challenge», полученным от сервера, и с «UserName» клиента, а затем хеширует результат с помощью [SHA-1](https://ru.wikipedia.org/wiki/SHA-1 "SHA-1"). Первые восемь байт этого хеша называются «Challenge Hash».
-   3c. 16-байтовый NT-хеш пароля клиента дополняется до 21 байта присоединением пяти нулевых байт. Пусть X, Y, Z будут тремя последовательными 7-байтовыми блоками этого 21-байтового значения, и пусть значение СH равно «Challenge Hash». Ответ CR длиной 24 байта, называемый «Challenge Response», вычисляется [так](https://wikimedia.org/api/rest_v1/media/math/render/svg/5d28dc539802b36aaf88ef09a0a48eacae86f88a)
-   3d. Клиент отправляет на сервер «Challenge Response», «Peer Authenticator Challenge» и «UserName».
-   4а. Сервер, получив ответ клиента, расшифровывает «Challenge Response» и сравнивает полученный NT-хеш клиента со своим. Если значения совпадают, то подлинность клиента подтверждается. Затем сервер хеширует 16-байтовый NT-хеш пароля, чтобы получить хеш-хеша пароля. (Сервер хранит пароль клиентов хешированным с помощью MD4; это и является NT- хешем пароля)
-   4b. Сервер конкатенирует хеш-хеша пароля, 24-байтовый «Challenge Response» и символьную строку «Magic server to client constant», а потом хеширует результат с помощью SHA-1.
-   4c. Сервер конкатенирует 20-байтовый выход [SHA-1](https://ru.wikipedia.org/wiki/SHA-1 "SHA-1") со стадии (4b), начальные 8 байт сгенерированного клиентом «Peer Authenticator Challenge» и символьную строку «Pad to make it do more than one iteration», а затем хеширует результат с помощью SHA-1.
-   4d. Полученные на стадии 20 байт являются «Authenticator Response» и отправляются клиенту в Success-пакете.
-   5\. Клиент также вычисляет «Authenticator Response» и сверяет с «Authenticator Response», полученным от сервера. Если значения совпадают, то подлинность сервера подтверждается и клиент отправляет серверу Success-пакет.






# Kerberos [Kerberos — Википедия (wikipedia.org)](https://ru.wikipedia.org/wiki/Kerberos)




# SAML [SAML — Википедия (wikipedia.org)](https://ru.wikipedia.org/wiki/SAML)






